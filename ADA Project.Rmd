---
title: "ADA Data Analysis"
output:
  html_document: default
  pdf_document: default
---
### All Data is taken from the 2021 and 2020 County Health Rankings

### Stata Code for County Data
``` {r}
# import delimited "/Users/nkolesky/Desktop/ADA/revised_county_health.csv", encoding(UTF-8) 
# replace obe_21=0 if obe_21<=33
# replace obe_21=1 if obe_21>33
# drop if obe_21==.
# drop if fei_20==.
# drop if pi_20==.
# drop if aeo_20==.
# drop if uni_20==.
# drop if ieq_20==.
# save "/Users/nkolesky/Desktop/ADA/usa_county_health_dichot.dta"
```

### Stata Code for State Data
``` {r}
# import delimited "/Users/nkolesky/Desktop/state_data.csv", varnames(1) encoding(UTF-8) 
# encode county, generate(substate)
# drop county
# keep if substate ==.
# save "/Users/nkolesky/Desktop/ADA/state_data.dta"
```

### Uploading County Stata .dta file
```{r}
#library(haven)
#usa_county_health_dichot <- read_dta("Desktop/ADA/usa_county_health_dichot.dta") 
#View(usa_county_health_dichot)
```

### Uploading State Stata .dta file
```{r}
#library(haven)
#state_data <- read_dta("Desktop/ADA/state_data.dta")
#View(state_data)
```

### Uploading County Non-dichot .dta file
```{r}
#library(haven)
#county_health_data <- read_dta("Desktop/ADA/county_health_data.dta")
#View(county_health_data)
```

### Read in .csv datasets
```{r}
# County Health
county_health_data <- read.csv("~/Desktop/ADA/county_health_data.csv") #Read
View(county_health_data) #Verify

#Dichot County Health
usa_county_health_dichot <- read.csv("~/Desktop/ADA/usa_county_health_dichot.csv") #Read
View(usa_county_health_dichot) #Verify

#State Level Data
state_data <- read.csv("~/Desktop/ADA/state_data.csv") #Read
View(state_data) #Verify
```

###Load in Packages
```{r}
library(arsenal)
library(beeswarm)
library(boot)
library(dpylr)
library(forcats)
library(ggbeeswarm)
library(ggcorrplot)
library(ggplot2)
library(graphics)
library(grDevices)
library(haven)
library(htmlTable)
library(knitr)
library(methods)
library(purr)
library(readr)
library(scales)
library(stats)
library(stringr)
library(tibble)
library(tidyr)
library(tidyverse)
library(utils)
library(vipor)
```
### Logistic Regression
```{r}
obelogit <- glm(obe_dichot ~ fei + smk + aeo + pcpr + chs + csc + pue + cip + ir + sph + shp + hmo + fi + lahf + uia + uic + tui + efl + wnws + rural + mhi + wv + rural_dichot, data = Capstone_analysis, family = "binomial") # Core of the analysis

summary(obelogit) # Print to verify
confint(obelogit)
exp(cbind(OR= coef(obelogit), confint(obelogit))) # 95% CI + OR

Capstone_analysis$obeprob <- round(fitted(obelogit), 2) #New variable and significant figures
```

## Tables
```{r}
classificationtable <- table(Capstone_analysis$obe, Capstone_analysis$obeprob >.5) 
classificationtable # Print to verify

sensitivity<-(classificationtable[2,2]/(classificationtable[2,2]+classificationtable[2,1]))*100 # Test the sensitivity of the analysis
sensitivity # Print to verify

specificity<-(classificationtable[1,1]/(classificationtable[1,1]+classificationtable[1,2]))*100 # Test the specificity of the analysis
specificity # Print to verify


#Table One
Capstone_analysis$region <- 
    factor(Capstone_analysis$region, 
           levels=c(1,2,3,4,5,6,7,8),
           labels=c("New England", 
                   "Mideast", 
                   "Great Lakes", 
                   "Plains", 
                   "Southeast",
                   "Southwest",
                   "Rocky Mountain",
                   "Far West"))  ### Establish Labels for the table
tab1 <- tableby(region ~ obe + smk + aeo + cip + shp + hmo + efl + mhi, data=Capstone_analysis) ###Build table
summary(tab1, text=TRUE) ###Verify
```

## Plots
```{r}
# Forest Plot

datobe <- data.frame(
Index = c(1, 2, 3, 4, 5, 6, 7),
label = c("Smoking (%)", "Access to Exercise Opportunities (%)", "Children in Poverty (%)", "Single Parent Home (%)", "Home Ownership (%)", "Eligible for Free Lunches (%)", "Median Household Income"),                      # Establishing Labels
OR = c(1.232944, .9808057, .9690945, .8987841, .9682440, 1.027472, 1.000017),  # Odds Ratio
LL = c(1.178497, .9743665, .9407422, .8687682, .9506359, 1.016394, 1.000003),   # Lower Limit
UL = c(1.2909432, .9872203, .9983822, .9291330, .9860606, 1.0388018, 1.0000308), # Upper Limit
CI = c("1.178497, 1.2909432", ".9743665, .9872203", ".9407422, .9983822", ".8687682, .9291330", ".9506359, .9860606", "1.016394, 1.0388018", " 1.000003, 1.0000308")
)
datobe # Verify

plot3 <- ggplot(datobe, aes(y = Index, x = OR)) +
    geom_point(shape = 18, size = 5) +  
    geom_errorbarh(aes(xmin = LL, xmax = UL), height = 0.25) +
    geom_vline(xintercept = 1, color = "red", linetype = "dashed", cex = 1, alpha = 0.5) +
    scale_y_continuous(name = "", breaks=1:7, labels = datobe$label, trans = "reverse") +
    xlab("Odds Ratio (95% CI)") + 
    ylab(" ") + 
    theme_bw() +
    theme(panel.border = element_blank(),
          panel.background = element_blank(),
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          axis.line = element_line(colour = "black"),
          axis.text.y = element_text(size = 12, colour = "black"),
          axis.text.x.bottom = element_text(size = 12, colour = "black"),
          axis.title.x = element_text(size = 12, colour = "black")) 
plot3
```
# Correlation Plot
```{r}
obecor <- dplyr::select_if(Capstone_analysis, is.numeric)
obeplot <- cor(obecor, use="complete.obs")
round(obeplot, 2)        # Verify
ggcorrplot(obeplot)      # Correlation Plot
```
# Logistic Regression Models 

#Smoking
```{r}
model <- glm(obe_dichot ~ smk, data=Capstone_analysis, family=binomial)

#define new data frame that contains predictor variable
newdata <- data.frame(smk=seq(min(Capstone_analysis$smk), max(Capstone_analysis$smk),len=500))

#use fitted model to predict values of obesity
newdata$obe_dichot = predict(model, newdata, type="response")

#plot logistic regression curve
plot(obe_dichot ~ smk, data=Capstone_analysis, col="steelblue")
lines(obe_dichot ~ smk, newdata, lwd=2)
```
#Access to Exercise Opportunities
```{r}
model <- glm(obe_dichot ~ smk, data=Capstone_analysis, family=binomial)

#define new data frame that contains predictor variable
newdata <- data.frame(smk=seq(min(Capstone_analysis$smk), max(Capstone_analysis$smk),len=500))

#use fitted model to predict values of obesity
newdata$obe_dichot = predict(model, newdata, type="response")

#plot logistic regression curve
plot(obe_dichot ~ smk, data=Capstone_analysis, col="steelblue")
lines(obe_dichot ~ smk, newdata, lwd=2)
```

#Children in Poverty
```{r}
model <- glm(obe_dichot ~ cip, data=Capstone_analysis, family=binomial)

#define new data frame that contains predictor variable
newdata <- data.frame(cip=seq(min(Capstone_analysis$cip), max(Capstone_analysis$cip),len=500))

#use fitted model to predict values of obesity
newdata$obe_dichot = predict(model, newdata, type="response")

#plot logistic regression curve
plot(obe_dichot ~ cip, data=Capstone_analysis, col="steelblue")
lines(obe_dichot ~ cip, newdata, lwd=2)
```
#Single Parent Home
```{r}
model <- glm(obe_dichot ~ sph, data=Capstone_analysis, family=binomial)

#define new data frame that contains predictor variable
newdata <- data.frame(sph=seq(min(Capstone_analysis$sph), max(Capstone_analysis$sph),len=500))

#use fitted model to predict values of obesity
newdata$obe_dichot = predict(model, newdata, type="response")

#plot logistic regression curve
plot(obe_dichot ~ sph, data=Capstone_analysis, col="steelblue")
lines(obe_dichot ~ sph, newdata, lwd=2)
```

#Home Ownership
```{r}
model <- glm(obe_dichot ~ hmo, data=Capstone_analysis, family=binomial)

#define new data frame that contains predictor variable
newdata <- data.frame(hmo=seq(min(Capstone_analysis$hmo), max(Capstone_analysis$hmo),len=500))

#use fitted model to predict values of obesity
newdata$obe_dichot = predict(model, newdata, type="response")

#plot logistic regression curve
plot(obe_dichot ~ hmo, data=Capstone_analysis, col="steelblue")
lines(obe_dichot ~ hmo, newdata, lwd=2)
```
#Eligible for Free Lunches
```{r}
model <- glm(obe_dichot ~ efl, data=Capstone_analysis, family=binomial)

#define new data frame that contains predictor variable
newdata <- data.frame(efl=seq(min(Capstone_analysis$efl), max(Capstone_analysis$efl),len=500))

#use fitted model to predict values of obesity
newdata$obe_dichot = predict(model, newdata, type="response")

#plot logistic regression curve
plot(obe_dichot ~ efl, data=Capstone_analysis, col="steelblue")
lines(obe_dichot ~ efl, newdata, lwd=2)
```

#Median Household Income
```{r}
model <- glm(obe_dichot ~ mhi, data=Capstone_analysis, family=binomial)

#define new data frame that contains predictor variable
newdata <- data.frame(mhi=seq(min(Capstone_analysis$mhi), max(Capstone_analysis$mhi),len=500))

#use fitted model to predict values of obesity
newdata$obe_dichot = predict(model, newdata, type="response")

#plot logistic regression curve
plot(obe_dichot ~ mhi, data=Capstone_analysis, col="steelblue")
lines(obe_dichot ~ mhi, newdata, lwd=2)
```

#Cleveland Plot Charts for Significant Associations
```{r}
#Obesity Rate
state_obe <- Capstone_analysis %>%
        group_by(state) %>%
        summarise(obe = mean(obe, na.rm = TRUE)) %>%
        arrange(obe) %>%
        mutate(state = factor(state, levels = .$state))
        
ggplot(state_obe, 
       aes(x=obe, 
           y=reorder(state, obe))) +
    geom_point(color="blue", 
               size = 2) +
    geom_segment(aes(x = 40, 
                     xend = obe, 
                     y = reorder(state, obe), 
                     yend = reorder(state, obe)),
                 color = "lightgrey") +
    labs (x = "Obesity Rate (%)",
          y = "",
          title = "Obesity Rate by State",
          subtitle = "County Health Rankings Data - 2021") +
    theme_minimal() + 
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())

#Smoking

state_smk <- Capstone_analysis %>%
        group_by(state) %>%
        summarise(smk = mean(smk, na.rm = TRUE)) %>%
        arrange(smk) %>%
        mutate(state = factor(state, levels = .$state))
ggplot(state_smk, 
       aes(x=smk, 
           y=reorder(state, smk))) +
    geom_point(color="blue", 
               size = 2) +
    geom_segment(aes(x = 40, 
                     xend = smk, 
                     y = reorder(state, smk), 
                     yend = reorder(state, smk)),
                 color = "lightgrey") +
    labs (x = "Smoking Rate (%)",
          y = "",
          title = "Smoking Rate by State",
          subtitle = "County Health Rankings Data - 2021") +
    theme_minimal() + 
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())

#Access to Exercise Opportunities
state_aeo <- Capstone_analysis %>%
        group_by(state) %>%
        summarise(aeo = mean(aeo, na.rm = TRUE)) %>%
        arrange(aeo) %>%
        mutate(state = factor(state, levels = .$state))
        
ggplot(state_aeo, 
       aes(x=aeo, 
           y=reorder(state, aeo))) +
    geom_point(color="blue", 
               size = 2) +
    geom_segment(aes(x = 40, 
                     xend = aeo, 
                     y = reorder(state, aeo), 
                     yend = reorder(state, aeo)),
                 color = "lightgrey") +
    labs (x = "Access to Exercise Opportunities(%)",
          y = "",
          title = "Access to Exercise Opportunities by State",
          subtitle = "County Health Rankings Data - 2021") +
    theme_minimal() + 
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())

#Children in Poverty
state_cip <- Capstone_analysis %>%
        group_by(state) %>%
        summarise(cip = mean(cip, na.rm = TRUE)) %>%
        arrange(cip) %>%
        mutate(state = factor(state, levels = .$state))
        
ggplot(state_cip, 
       aes(x=cip, 
           y=reorder(state, cip))) +
    geom_point(color="blue", 
               size = 1.5) +
    geom_segment(aes(x = 40, 
                     xend = cip, 
                     y = reorder(state, cip), 
                     yend = reorder(state, cip)),
                 color = "lightgrey") +
    labs (x = "Children in Poverty(%)",
          y = "",
          title = "Rate of Children in Poverty by State",
          subtitle = "County Health Rankings Data - 2021") +
    theme_minimal() + 
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())
          
#Single Parent Home
state_sph <- Capstone_analysis %>%
        group_by(state) %>%
        summarise(sph = mean(sph, na.rm = TRUE)) %>%
        arrange(sph) %>%
        mutate(state = factor(state, levels = .$state))
        
ggplot(state_sph, 
       aes(x=sph, 
           y=reorder(state, sph))) +
    geom_point(color="blue", 
               size = 1.5) +
    geom_segment(aes(x = 40, 
                     xend = sph,
                     y = reorder(state, sph), 
                     yend = reorder(state, sph)),
                 color = "lightgrey") +
    labs (x = "Single Parent Home (%)",
          y = "",
          title = "Single Parent Home Rate by State",
          subtitle = "County Health Rankings Data - 2021") +
    theme_minimal() + 
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())
          
#Home Ownership
state_hmo <- Capstone_analysis %>%
        group_by(state) %>%
        summarise(hmo = mean(hmo, na.rm = TRUE)) %>%
        arrange(hmo) %>%
        mutate(state = factor(state, levels = .$state))
        
ggplot(state_hmo, 
       aes(x=hmo,
           y=reorder(state, hmo))) +
    geom_point(color="blue", 
               size = 1.5) +
    geom_segment(aes(x = 40, 
                     xend = hmo, 
                     y = reorder(state, hmo), 
                     yend = reorder(state, hmo)),
                 color = "lightgrey") +
    labs (x = "Home Ownership",
          y = "",
          title = "Home Ownership by State",
          subtitle = "County Health Rankings Data - 2021") +
    theme_minimal() + 
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())
          
#Eligible for Free Lunches
state_efl <- Capstone_analysis %>%
        group_by(state) %>%
        summarise(efl = mean(efl, na.rm = TRUE)) %>%
        arrange(efl) %>%
        mutate(state = factor(state, levels = .$state))
        
ggplot(state_efl, 
       aes(x=efl, 
           y=reorder(state, efl))) +
    geom_point(color="blue", 
               size = 1.5) +
    geom_segment(aes(x = 40, 
                     xend = efl, 
                     y = reorder(state, efl), 
                     yend = reorder(state, efl)),
                 color = "lightgrey") +
    labs (x = "Eligible for Free Lunches (%)",
          y = "",
          title = "Percent Eligible for Free Lunches by State",
          subtitle = "County Health Rankings Data - 2021") +
    theme_minimal() + 
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())

#Median Household Income
state_mhi <- Capstone_analysis %>%
        group_by(state) %>%
        summarise(mhi = mean(mhi, na.rm = TRUE)) %>%
        arrange(mhi) %>%
        mutate(state = factor(state, levels = .$state))
        
ggplot(state_mhi, 
       aes(x=mhi, 
           y=reorder(state, mhi))) +
    geom_point(color="blue", 
               size = 1.5) +
    geom_segment(aes(x = 40, 
                     xend = mhi, 
                     y = reorder(state, mhi), 
                     yend = reorder(state, mhi)),
                 color = "lightgrey") +
    labs (x = "Median Household Income",
          y = "",
          title = "Median Household Income by State",
          subtitle = "County Health Rankings Data - 2021") +
    theme_minimal() + 
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())
```
# Lines of Best Fit
```{r}

#SMK
ggplot(Capstone_analysis,
aes(x = smk,
y = obe)) +
geom_point(color= "steelblue") +
geom_smooth(method = "lm") +
    labs(title = "Obesity Rate by Smoking", 
         x = "Smoking (%)",
         y = "Obesity Rate (%)") +
    theme_minimal() +
    theme(legend.position = "none")

#AEO
ggplot(Capstone_analysis,
aes(x = aeo,
y = obe)) +
geom_point(color= "steelblue") +
geom_smooth(method = "lm") +
    labs(title = "Obesity Rate by Access to Exercise Opportunities", 
         x = "Access to Exercise Opportunities (%)",
         y = "Obesity Rate (%)") +
    theme_minimal() +
    theme(legend.position = "none")
    
    
#CIP
ggplot(Capstone_analysis,
aes(x = cip,
y = obe)) +
geom_point(color= "steelblue") +
geom_smooth(method = "lm") +
    labs(title = "Obesity Rate by Children in Poverty", 
         x = "Children in Poverty (%)",
         y = "Obesity Rate (%)") +
    theme_minimal() +
    theme(legend.position = "none")

#SPH
ggplot(Capstone_analysis,
aes(x = sph,
y = obe)) +
geom_point(color= "steelblue") +
geom_smooth(method = "lm") +
    labs(title = "Obesity Rate by Single Parent Homes", 
         x = "Single Parent Homes (%)",
         y = "Obesity Rate (%)") +
    theme_minimal() +
    theme(legend.position = "none")

#HMO
ggplot(Capstone_analysis,
aes(x = aeo,
y = obe)) +
geom_point(color= "steelblue") +
geom_smooth(method = "lm") +
    labs(title = "Obesity Rate by Home Ownership", 
         x = "Home Ownership (%)",
         y = "Obesity Rate (%)") +
    theme_minimal() +
    theme(legend.position = "none")

#EFL
ggplot(Capstone_analysis,
aes(x = efl,
y = obe)) +
geom_point(color= "steelblue") +
geom_smooth(method = "lm") +
    labs(title = "Obesity Rate by Eligibity for Free Lunches", 
         x = "Eligible for Free Lunches (%)",
         y = "Obesity Rate (%)") +
    theme_minimal() +
    theme(legend.position = "none")
       
# MHI
ggplot(Capstone_analysis,
aes(x = mhi,
y = obe)) +
geom_point(color= "steelblue") +
geom_smooth(method = "lm") +
    labs(title = "Obesity Rate by Median Household Income", 
         x = "Median Household Income ($)",
         y = "Obesity Rate (%)") +
    theme_minimal() +
    theme(legend.position = "none")
```

#Beeswarm Plots
```{r}
#Establish Values
View(Capstone_analysis)
View(Capstone_analysis)
Regions.data <- read.csv("~/Desktop/Capstone/Regions data.csv")
View(Regions.data)

plotdata <- Regions.data%>%
    group_by(region) %>%
    summarize(n = n(),
        obe = mean(obe),
        sd = sd(obe),
        se = sd / sqrt(n),
        ci = qt(0.975, df = n - 1) * sd / sqrt(n))

#Plot the Regional Data
ggplot(Regions.data, 
       aes(x = factor(region,
                      labels = c("New England",
                                 "Mideast",
                                 "Great Lakes", "Plains", "Southeast", "Southwest", "Rocky Mountain", "Far West")), 
           y = obe, 
           color = region)) +
    geom_quasirandom(alpha = 0.7,
                     size = 1.5) + 
    scale_y_continuous(label = ) +
    labs(title = "Obesity Rate by Region", 
         subtitle = "Obesity Rate for 2021",
         x = "",
         y = "Obesity Rate (%)") +
    theme_minimal() +
    theme(legend.position = "none")

# Plots for Obesity Probality   
ggplot(Regions.data, 
       aes(x = factor(region,
                      labels = c("New England",
                                 "Mideast",
                                 "Great Lakes", "Plains", "Southeast", "Southwest", "Rocky Mountain", "Far West")), 
           y = obeprob, 
           color = region)) +
    geom_quasirandom(alpha = 0.7,
                     size = 1.5) + 
    scale_y_continuous(label = ) +
    labs(title = "Obesity Probality by Region", 
         x = "",
         y = "Obesity Probality") +
    theme_minimal() +
    theme(legend.position = "none")
```
### Dichot Variables
```{r}

#### Work in Progress
# Find Areas of Significance
model <- glm(obe_dichot ~ rural_dichot + wv,
family = "binomial",
data = Capstone_analysis,
na.action = na.exclude)
summary(model)

obelogit <- glm(obe ~ fei + smk + aeo + pcpr + chs + csc + pue + cip + ir + sph + shp + hmo + fi + lahf + uia + uic + tui + efl + wnws + rural + mhi + wv + rural_dichot, data = Regions.data, family = "binomial") # Core of the analysis
summary(obelogit) # Print to verify
confint(obelogit)
exp(cbind(OR= coef(obelogit), confint(obelogit))) # 95% CI + OR

Regions.data$obeprob <- round(fitted(obelogit), 2) #New variable and significant figures

#Plot
ggplot(Regions.data, aes(x = smk, y = obeprob)) + geom_ribbon(aes(ymin = LL,
    ymax = UL, fill = rank), alpha = 0.2) + geom_line(aes(colour = region),
    size = 1)
####

# Box Plots
boxplot(obeprob~wv,data=Regions.data, main="Box Plot of Obesity Probabity by Unsafe Water",
   xlab="Water Violations", ylab="Obesity Probality")
   
boxplot(obeprob~rural_dichot,data=Regions.data, main="Box Plot of Obesity Probabity by Rurality",
   xlab="Rural Majority County", ylab="Obesity Probality")


ggplot(Regions.data, aes(x=wv, y=obe, fill=name)) +
geom_boxplot() +
scale_fill_viridis(discrete = TRUE, alpha=0.6) +
geom_jitter(color="black", size=0.4, alpha=0.9) +
theme_ipsum() +
theme(
legend.position="none",
plot.title = element_text(size=11)
) +
ggtitle("A boxplot with jitter") +
xlab("")
